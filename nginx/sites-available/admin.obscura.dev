upstream admin {
  server admin:3000;
  keepalive 64;
}

upstream admin-webpack {
  server admin:3001;
  keepalive 64;
}

server {
  listen          80;
  listen          [::]:80;
  server_name    admin.obscura.dev;
  return         301 https://$server_name$request_uri;
}

server {
  listen                    443 ssl http2;
  listen                    [::]:443 ssl http2;
  server_name               admin.obscura.dev;

  ssl                         on;
  ssl_ciphers                 HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
  ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
  ssl_session_cache           builtin:1000  shared:SSL:10m;
  ssl_certificate             /etc/nginx/ssl/obscura.dev.crt;
  ssl_certificate_key         /etc/nginx/ssl/obscura.dev.key;
  ssl_prefer_server_ciphers   on;

  location /dist {
    proxy_pass              http://admin-webpack;
    include                 /etc/nginx/shared/node-http2.conf;
  }

  location /__webpack_hmr {
    proxy_pass              http://admin-webpack;
    include                 /etc/nginx/shared/node-http2.conf;
  }

  location / {
    proxy_pass              http://admin$request_uri;
    include                 /etc/nginx/shared/node-http2.conf;
  }

  access_log    /var/log/nginx/access.log;
  error_log     /var/log/nginx/error.log warn;
}
